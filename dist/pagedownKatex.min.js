angular.module("pagedownKatex",[]),angular.module("pagedownKatex").factory("katexHtmlRenderer",[function(){function splitAtDelimiters(startData,leftDelim,rightDelim,display){for(var finalData=[],i=0;i<startData.length;i++)if("text"===startData[i].type){var nextIndex,text=startData[i].data,lookingForLeft=!0,currIndex=0;for(nextIndex=text.indexOf(leftDelim),-1!==nextIndex&&(currIndex=nextIndex,finalData.push({type:"text",data:text.slice(0,currIndex)}),lookingForLeft=!1);;){if(lookingForLeft){if(nextIndex=text.indexOf(leftDelim,currIndex),-1===nextIndex)break;finalData.push({type:"text",data:text.slice(currIndex,nextIndex)}),currIndex=nextIndex}else{if(nextIndex=findEndOfMath(rightDelim,text,currIndex+leftDelim.length),-1===nextIndex)break;finalData.push({type:"math",data:text.slice(currIndex+leftDelim.length,nextIndex),rawData:text.slice(currIndex,nextIndex+rightDelim.length),display:display}),currIndex=nextIndex+rightDelim.length}lookingForLeft=!lookingForLeft}finalData.push({type:"text",data:text.slice(currIndex)})}else finalData.push(startData[i]);return finalData}function splitWithDelimiters(text,delimiters){for(var data=[{type:"text",data:text}],i=0;i<delimiters.length;i++){var delimiter=delimiters[i];data=splitAtDelimiters(data,delimiter.left,delimiter.right,delimiter.display||!1)}return data}function renderMathInText(text,delimiters){for(var data=splitWithDelimiters(text,delimiters),fragment=document.createDocumentFragment(),i=0;i<data.length;i++)if("text"===data[i].type)fragment.appendChild(document.createTextNode(data[i].data));else{var span=document.createElement("span"),math=data[i].data;try{katex.render(math,span,{displayMode:data[i].display})}catch(e){if(!(e instanceof katex.ParseError))throw e;console.error("KaTeX auto-render: Failed to parse `"+data[i].data+"` with ",e),fragment.appendChild(document.createTextNode(data[i].rawData));continue}fragment.appendChild(span)}return fragment}function renderElem(elem,delimiters,ignoredTags){for(var i=0;i<elem.childNodes.length;i++){var childNode=elem.childNodes[i];if(3===childNode.nodeType){var frag=renderMathInText(childNode.textContent,delimiters);i+=frag.childNodes.length-1,elem.replaceChild(frag,childNode)}else if(1===childNode.nodeType){var shouldRender=-1===ignoredTags.indexOf(childNode.nodeName.toLowerCase());shouldRender&&renderElem(childNode,delimiters,ignoredTags)}}}function getRenderedHtml(htmlString,options){if(""===htmlString)return"";void 0===options&&(options=defaultOptions);var delimiters=options.delimiters,ignoredTags=options.ignoredTags,domElems=$(htmlString).get(),elem=$("<div></div>");for(i=0;i<domElems.length;i++)renderElem(domElems[i],delimiters,ignoredTags),elem.append(domElems[i]);return elem.html()}var findEndOfMath=function(delimiter,text,startIndex){for(var index=startIndex,braceLevel=0,delimLength=delimiter.length;index<text.length;){var character=text[index];if(0>=braceLevel&&text.slice(index,index+delimLength)===delimiter)return index;"\\"===character?index++:"{"===character?braceLevel++:"}"===character&&braceLevel--,index++}return-1},defaultOptions={delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}],ignoredTags:["script","noscript","style","textarea","pre","code"]};return{getRenderedHtml:getRenderedHtml}}]);var mdExtraOptions={extensions:"all",table_class:"table"};angular.module("pagedownKatex").directive("pagedownKatexEditor",["$compile","$timeout","$window","$q","katexHtmlRenderer",function($compile,$timeout,$window,$q,katexHtmlRenderer){var nextId=0,converter=Markdown.getSanitizingConverter();return Markdown.Extra.init(converter,mdExtraOptions),converter.hooks.chain("preBlockGamut",function(text,rbg){return text.replace(/^ {0,3}""" *\n((?:.*?\n)+?) {0,3}""" *$/gm,function(whole,inner){return"<blockquote>"+rbg(inner)+"</blockquote>\n"})}),{restrict:"E",require:"ngModel",scope:{ngModel:"=",placeholder:"@",showPreview:"@",help:"&",insertImage:"&",editorClass:"=?",editorRows:"@",previewClass:"=?",previewContent:"=?"},link:function(scope,element,attrs,ngModel){scope.changed=function(){scope.$parent.$eval(attrs.ngChange)};var editorUniqueId;editorUniqueId=null==attrs.id?nextId++:attrs.id;var previewHiddenStyle="false"==scope.showPreview?"display: none;":"",placeholder=attrs.placeholder||"",editorRows=attrs.editorRows||"10",newElement=$compile('<div><div class="wmd-panel"><div id="wmd-button-bar-'+editorUniqueId+'"></div><textarea id="wmd-input-'+editorUniqueId+'" placeholder="'+placeholder+'" ng-model="ngModel" ng-change="changed()" rows="'+editorRows+'" '+(scope.editorClass?'ng-class="editorClass"':'class="wmd-input"')+'></textarea></div><div id="wmd-preview-'+editorUniqueId+'" style="'+previewHiddenStyle+'" '+(scope.previewClass?'ng-class="previewClass"':'class="wmd-panel wmd-preview"')+"></div></div>")(scope);element.append(newElement);var help=angular.isFunction(scope.help)?scope.help:function(){$window.open("http://daringfireball.net/projects/markdown/syntax","_blank")},editor=new Markdown.Editor(converter,"-"+editorUniqueId,{handler:help}),editorElement=angular.element(document.getElementById("wmd-input-"+editorUniqueId));editorElement.val(scope.ngModel),converter.hooks.chain("postConversion",function(text){ngModel.$setViewValue(editorElement.val());var renderedHtml=katexHtmlRenderer.getRenderedHtml(text),preview=angular.element(document.getElementById("wmd-preview-"+editorUniqueId));return scope.previewContent=preview.html(),renderedHtml}),"false"!=scope.showPreview&&scope.$watch("content",function(){editor.refreshPreview()}),editor.hooks.chain("onPreviewRefresh",function(){$timeout(function(){scope.content=editorElement.val()})}),angular.isFunction(scope.insertImage)&&editor.hooks.set("insertImageDialog",function(callback){var result=scope.insertImage();return $timeout(function(){result?$q.when(result).then(function(imgUrl){callback(imgUrl)},function(reason){callback(null)}):callback(null)}),!0}),editor.run()}}}]).directive("pagedownKatexViewer",["$compile","$sce",function($compile,$sce){var converter=Markdown.getSanitizingConverter();return Markdown.Extra.init(converter,mdExtraOptions),{restrict:"E",scope:{content:"="},link:function(scope,element,attrs){var run=function(){return scope.content?void(scope.sanitizedContent=$sce.trustAsHtml(converter.makeHtml(scope.content))):void(scope.sanitizedContent="")};scope.$watch("content",run),run();var newElementHtml="<p ng-bind-html='sanitizedContent'></p>",newElement=$compile(newElementHtml)(scope);element.append(newElement)}}}]);